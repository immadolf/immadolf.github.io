<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="weiyu luo,fqluowy@gmail.com"><title>Spring Conversion学习 · immadolf</title><meta name="description" content="Spring ConversionService框架1. AbstractApplicationContextAbstractApplicationContext#finishBeanFactoryInitialization方法中会检查容器中是否存在名为conversionservice的类型为C"><meta name="keywords" content="Hexo,Java,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">immadolf</a></h3><div class="description"><p>Nothing lasts forever.</p></div></div></div><ul class="social-links"><li><a href="http://github.com/immadolf"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Spring Conversion学习</a></h3></div><div class="post-content"><h1 id="Spring-ConversionService框架"><a href="#Spring-ConversionService框架" class="headerlink" title="Spring ConversionService框架"></a>Spring ConversionService框架</h1><h2 id="1-AbstractApplicationContext"><a href="#1-AbstractApplicationContext" class="headerlink" title="1. AbstractApplicationContext"></a>1. AbstractApplicationContext</h2><p><code>AbstractApplicationContext#finishBeanFactoryInitialization</code>方法中会检查容器中是否存在名为<code>conversionservice</code>的类型为<code>ConversionService</code>的Bean，如果有，就将其设置到容器对象的<code>conversionService</code>属性中。</p>
<h2 id="2-BeanFactory和FactoryBean"><a href="#2-BeanFactory和FactoryBean" class="headerlink" title="2. BeanFactory和FactoryBean"></a>2. <a href="https://www.cnblogs.com/redcool/p/6413461.html" target="_blank" rel="noopener">BeanFactory和FactoryBean</a></h2><p>实际上容器中名为<code>conversionservice</code>的Bean的真实类型为<code>ConversionServiceFactoryBean</code>，而当从容器(BeanFactory)中根据BeanId来获取Bean的实例时，如果该Id对应的Bean是一个<code>FactoryBean</code>，那么实际返回并不是<code>FactoryBean</code>的实例而是<code>FactoryBean#getObject()</code>的返回值对象。</p>
<h2 id="3-ConversionServiceFactoryBean"><a href="#3-ConversionServiceFactoryBean" class="headerlink" title="3. ConversionServiceFactoryBean"></a>3. <span id="jump3">ConversionServiceFactoryBean</span></h2><p><code>ConversionServiceFactoryBean</code>实现了<code>InitializingBean</code>接口，所以在bean初始化之后<code>afterPropertiesSet</code>方法会被调用，<code>afterPropertiesSet</code>方法中会调用<code>createConversionService()</code>来创建<code>ConversionService</code>对象，<code>createConversionService()</code>默认创建的是<code>DefaultConversionService</code>对象，<code>ConversionServiceFactoryBean</code>的子类可以重写<code>createConversionService()</code>来创建其它的<code>ConversionService</code>对象。<br><code>afterPropertiesSet</code>方法中还会调用<code>ConversionServiceFactory#registerConverters</code>方法，并将上一步中创建的<code>ConversionService</code>对象以及<code>ConversionServiceFactoryBean</code>中的<code>converters</code>集合作为参数传入。</p>
<h2 id="4-ConversionService"><a href="#4-ConversionService" class="headerlink" title="4. ConversionService"></a>4. ConversionService</h2><p><code>ConversionService</code>是一个类型转换的服务接口，它是整个转换系统的入口。调用<code>ConversionService#convert(Object,Class)</code>方法会使用这个系统来进行一个类型安全的转换。<br><code>ConversionService</code>总共有四个方法，其中有两个是重载，所以实际上它只有两种方法，一个是用来判断能否将给定的原类型转换到目标类型，另一个就是真正的转换方法，将原类型转到目标类型。</p>
<h2 id="5-ConverterRegistry"><a href="#5-ConverterRegistry" class="headerlink" title="5. ConverterRegistry"></a>5. ConverterRegistry</h2><p><code>ConverterRegistry</code>用来将转换器注册到转换系统中。<code>ConverterRegistry</code>中有这几类方法：</p>
<ul>
<li>添加一个简单的转换器(<code>Converter&lt;Source,Target&gt;</code>)</li>
<li>添加一个通用的转换器(<code>GenericConverter</code>)</li>
<li>添加一个简单转换器的工厂(<code>ConverterFactory</code>)</li>
<li>删除可以转换指定原类型和目标类型的全部转换器</li>
</ul>
<h2 id="6-ConverterFactory"><a href="#6-ConverterFactory" class="headerlink" title="6. ConverterFactory"></a>6. ConverterFactory</h2><p><code>ConverterFactory</code>有两个泛型，一个是原类型S，另一个是目标类型的父类R，之后调用<code>getConverter()</code>方法时，只需传入任何R的子类T，就可以得到一个从S-&gt;R的转换器。</p>
<h2 id="7-ConfigurableConversionService"><a href="#7-ConfigurableConversionService" class="headerlink" title="7. ConfigurableConversionService"></a>7. ConfigurableConversionService</h2><p><code>ConfigurableConversionService</code>接口继承了<code>ConversionService</code>接口和<code>ConverterRegistry</code>接口。绝大多数<code>ConversionService</code>的子类应实现<code>ConfigurableConversionService</code>接口，它合并了<code>ConversionService</code>提供的只读方法和<code>ConverterRegistry</code>提供的可写方法，以便通过特殊方式添加和删除转换器。</p>
<h2 id="8-GenericConversionService"><a href="#8-GenericConversionService" class="headerlink" title="8. GenericConversionService"></a>8. GenericConversionService</h2><p><code>ConversionService</code>接口的基础实现，适用于大多数的环境。通过<code>ConfigurableConversionService</code>接口，间接的实现了<code>ConverterRegistry</code>的注册API。我们来看看这个类里面主要的几个方法：</p>
<ol>
<li>首先是几个添加转换器的方法，这里涉及到两个内部适配器类<code>ConverterAdapter</code>和<code>ConverterFactoryAdapter</code>，它们是<code>GenericConverter</code>的实现类，所以当添加一个简单的转换器和一个简单转换器的工厂时，会先用适配器进行适配，然后将适配器对象当做参数传递给添加通用转换器的方法（因为适配器对象是通用转换器类的子类）。最终，会将通用适配器对象添加到<code>GenericConversionService</code>对象的converters属性中。converters属性是内部类Converters的实例，可以把converters看成一个容器（它内部维护着一个Set和Map用来存放之前添加的<code>GenericConverter</code>），可以根据原类型和目标类型从中找出对应的<code>GenericConverter</code>。</li>
<li>第二个是判断能不能转换的方法，这里会用到上面说到的converters属性，根据原类型和目标类型从中查询是否有对应的转换器。</li>
<li>第三个就是真正转换的方法，步骤和第二条类似，根据原类型和目标类型从converters中取出相应的转换器，然后传入所需的参数即可。</li>
</ol>
<h2 id="9-DefaultConversionService"><a href="#9-DefaultConversionService" class="headerlink" title="9. DefaultConversionService"></a>9. DefaultConversionService</h2><p><code>DefaultConversionService</code>是<code>GenericConversionService</code>的子类，只是在<code>GenericConversionService</code>的基础上添加了许多Spring提供的转换器。</p>
<h2 id="10-ConversionServiceFactory"><a href="#10-ConversionServiceFactory" class="headerlink" title="10. ConversionServiceFactory"></a>10. ConversionServiceFactory</h2><p>在<a href="#jump3">第三条</a>中，我们提到了在创建完<code>DefaultConversionService</code>以后会调用<code>ConversionServiceFactory#registerConverters</code>方法。<code>ConversionServiceFactory</code>是一个抽象类，它只有一个方法，作用是用参数中的转换器注册器把给定的转换器集合注册到转换系统中。也就是在<code>DefaultConversionService</code>默认添加的转换器的基础上再添加用户需要的其它的转换器。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-03-17</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Spring/" title="Spring">Spring </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://immadolf.github.io/2018/03/17/Spring-Conversion学习/,immadolf,Spring Conversion学习,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/01/25/业务中的策略模式/" title="业务中的策略模式">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/03/13/二.如何使用Spring-Shell/" title="二.如何使用Spring Shell">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>